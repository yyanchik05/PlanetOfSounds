<!DOCTYPE html>
<html lang="uk">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PlanetOfSounds - –°—Ç–æ—Ä—ñ–Ω–∫–∞ –≥—É—Ä—Ç—É</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <header class="site-header">
      <div class="container header-inner">
        <h1 class="logo">PlanetOfSounds</h1>
        <nav class="main-nav">
          <a href="index.html">–ì–æ–ª–æ–≤–Ω–∞</a>
          <a href="bands.html">–ì—É—Ä—Ç–∏</a>
          <a href="add.html">–î–æ–¥–∞—Ç–∏ –≥—É—Ä—Ç</a>
        </nav>
        <div class="header-actions">
          <button id="themeToggle">üåû</button>
        </div>
      </div>
    </header>

    <main class="container">
      <section id="bandDetails" class="card"></section>
    </main>

    <footer class="site-footer">
      <div class="container">
        <p>¬©MusicWorld - –∑ –Ω–∞–º–∏, –±–æ –º–∏ –Ω–∞–π–∫—Ä–∞—â—ñ</p>
      </div>
    </footer>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
      import { getAuth } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
      import { getFirestore } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyB8HpfXZB4XElyIHWWD2kORt4rNTkBjOAM",
        authDomain: "planetofsounds.firebaseapp.com",
        projectId: "planetofsounds",
        storageBucket: "planetofsounds.firebasestorage.app",
        messagingSenderId: "100487931303",
        appId: "1:100487931303:web:4cb141cb332a21767f4282",
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      window.auth = auth;
      window.db = db;
    </script>

    <script type="module">
      import { getAuth } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
      import {
        getFirestore,
        collection,
        query,
        where,
        getDocs,
        doc,
        updateDoc,
        addDoc,
      } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

      document.addEventListener("DOMContentLoaded", async () => {
        const auth = window.auth;
        const db = window.db;

        const params = new URLSearchParams(window.location.search);
        const bandName = params.get("name");
        if (!bandName) return;

        const bandsCol = collection(db, "bands");
        const q = query(bandsCol, where("name", "==", bandName));
        const snap = await getDocs(q);

        const container = document.getElementById("bandDetails");

        if (snap.empty) {
          container.innerHTML = "<p>–ì—É—Ä—Ç –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ üòî</p>";
          return;
        }

        const docSnap = snap.docs[0];
        const band = { id: docSnap.id, ...docSnap.data() };

        let userLikedBands = [];
        if (auth.currentUser) {
          const likesCol = collection(db, "likes");
          const q2 = query(likesCol, where("uid", "==", auth.currentUser.uid));
          const snap2 = await getDocs(q2);
          if (!snap2.empty) {
            const likeDoc = snap2.docs[0];
            userLikedBands = likeDoc.data().likedBands || [];
          }
        }

        const renderLikeButton = () => {
          const liked = userLikedBands.includes(band.name);
          return `<button id="likeBtn" style="font-size:24px;background:none;border:none;cursor:pointer;">
        ${liked ? "‚ù§Ô∏è" : "ü§ç"} <span>${band.likes || 0}</span>
      </button>`;
        };

        container.innerHTML = `
      <h2>${band.name}</h2>
      <img src="${band.image}" alt="${band.name}" 
           style="width:100%;max-width:500px;height:auto;border-radius:10px;margin-bottom:10px;">
      <p><strong>–ñ–∞–Ω—Ä:</strong> ${band.genre}</p>
      <p><strong>–†—ñ–∫ –∑–∞—Å–Ω—É–≤–∞–Ω–Ω—è:</strong> ${band.year}</p>
      <p>${band.description}</p>
      <a href="${
        band.spotify
      }" target="_blank" class="btn">–í—ñ–¥–∫—Ä–∏—Ç–∏ —É Spotify</a>
      ${renderLikeButton()}
    `;

        const likeBtn = document.getElementById("likeBtn");
        if (likeBtn && auth.currentUser) {
          likeBtn.addEventListener("click", async () => {
            const likesCol = collection(db, "likes");
            const q2 = query(
              likesCol,
              where("uid", "==", auth.currentUser.uid)
            );
            const snap2 = await getDocs(q2);

            let likeDocRef = null;
            let likeData = null;
            if (!snap2.empty) {
              const doc2 = snap2.docs[0];
              likeDocRef = doc(db, "likes", doc2.id);
              likeData = doc2.data();
            }

            const liked = userLikedBands.includes(band.name);
            let newLiked = liked
              ? userLikedBands.filter((n) => n !== band.name)
              : [...userLikedBands, band.name];

            if (likeDocRef) {
              await updateDoc(likeDocRef, { likedBands: newLiked });
            } else {
              await addDoc(likesCol, {
                uid: auth.currentUser.uid,
                likedBands: newLiked,
              });
            }

            const newLikesCount = liked
              ? (band.likes || 1) - 1
              : (band.likes || 0) + 1;

            const bandDocRef = doc(db, "bands", band.id);
            await updateDoc(bandDocRef, { likes: newLikesCount });

            userLikedBands = newLiked;
            band.likes = newLikesCount;
            likeBtn.innerHTML = `${
              userLikedBands.includes(band.name) ? "‚ù§Ô∏è" : "ü§ç"
            } <span>${band.likes}</span>`;
          });
        } else if (!auth.currentUser && likeBtn) {
          likeBtn.addEventListener("click", () => {
            alert("–©–æ–± —Å—Ç–∞–≤–∏—Ç–∏ –ª–∞–π–∫–∏, –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—è!");
          });
        }
      });
    </script>

    <script type="module" src="script.js"></script>
  </body>
</html>
